{"ast":null,"code":"\"use strict\";\n\n/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Web3Subscription = void 0;\n// eslint-disable-next-line max-classes-per-file\nconst web3_types_1 = require(\"web3-types\");\nconst web3_utils_1 = require(\"web3-utils\");\nconst web3_errors_1 = require(\"web3-errors\");\n// eslint-disable-next-line import/no-cycle\nconst web3_subscription_manager_js_1 = require(\"./web3_subscription_manager.js\");\nconst web3_event_emitter_js_1 = require(\"./web3_event_emitter.js\");\nclass Web3Subscription extends web3_event_emitter_js_1.Web3EventEmitter {\n  constructor(args, options) {\n    var _a;\n    super();\n    this.args = args;\n    const {\n      requestManager\n    } = options;\n    const {\n      subscriptionManager\n    } = options;\n    if (requestManager && subscriptionManager) {\n      throw new web3_errors_1.SubscriptionError('Only requestManager or subscriptionManager should be provided at Subscription constructor');\n    }\n    if (!requestManager && !subscriptionManager) {\n      throw new web3_errors_1.SubscriptionError('Either requestManager or subscriptionManager should be provided at Subscription constructor');\n    }\n    if (requestManager) {\n      // eslint-disable-next-line deprecation/deprecation\n      this._subscriptionManager = new web3_subscription_manager_js_1.Web3SubscriptionManager(requestManager, {}, true);\n    } else {\n      this._subscriptionManager = subscriptionManager;\n    }\n    this._returnFormat = (_a = options === null || options === void 0 ? void 0 : options.returnFormat) !== null && _a !== void 0 ? _a : web3_types_1.DEFAULT_RETURN_FORMAT;\n  }\n  get id() {\n    return this._id;\n  }\n  get lastBlock() {\n    return this._lastBlock;\n  }\n  subscribe() {\n    return __awaiter(this, void 0, void 0, function* () {\n      return this._subscriptionManager.addSubscription(this);\n    });\n  }\n  processSubscriptionData(data) {\n    var _a, _b;\n    if (data === null || data === void 0 ? void 0 : data.data) {\n      // for EIP-1193 provider\n      this._processSubscriptionResult((_b = (_a = data === null || data === void 0 ? void 0 : data.data) === null || _a === void 0 ? void 0 : _a.result) !== null && _b !== void 0 ? _b : data === null || data === void 0 ? void 0 : data.data);\n    } else if (data && web3_utils_1.jsonRpc.isResponseWithNotification(data)) {\n      this._processSubscriptionResult(data === null || data === void 0 ? void 0 : data.params.result);\n    }\n  }\n  sendSubscriptionRequest() {\n    return __awaiter(this, void 0, void 0, function* () {\n      this._id = yield this._subscriptionManager.requestManager.send({\n        method: 'eth_subscribe',\n        params: this._buildSubscriptionParams()\n      });\n      this.emit('connected', this._id);\n      return this._id;\n    });\n  }\n  get returnFormat() {\n    return this._returnFormat;\n  }\n  get subscriptionManager() {\n    return this._subscriptionManager;\n  }\n  resubscribe() {\n    return __awaiter(this, void 0, void 0, function* () {\n      yield this.unsubscribe();\n      yield this.subscribe();\n    });\n  }\n  unsubscribe() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.id) {\n        return;\n      }\n      yield this._subscriptionManager.removeSubscription(this);\n    });\n  }\n  sendUnsubscribeRequest() {\n    return __awaiter(this, void 0, void 0, function* () {\n      yield this._subscriptionManager.requestManager.send({\n        method: 'eth_unsubscribe',\n        params: [this.id]\n      });\n      this._id = undefined;\n    });\n  }\n  // eslint-disable-next-line class-methods-use-this\n  formatSubscriptionResult(data) {\n    return data;\n  }\n  _processSubscriptionResult(data) {\n    this.emit('data', this.formatSubscriptionResult(data));\n  }\n  _processSubscriptionError(error) {\n    this.emit('error', error);\n  }\n  // eslint-disable-next-line class-methods-use-this\n  _buildSubscriptionParams() {\n    // This should be overridden in the subclass\n    throw new Error('Implement in the child class');\n  }\n}\nexports.Web3Subscription = Web3Subscription;","map":{"version":3,"names":["web3_types_1","require","web3_utils_1","web3_errors_1","web3_subscription_manager_js_1","web3_event_emitter_js_1","Web3Subscription","Web3EventEmitter","constructor","args","options","requestManager","subscriptionManager","SubscriptionError","_subscriptionManager","Web3SubscriptionManager","_returnFormat","_a","returnFormat","DEFAULT_RETURN_FORMAT","id","_id","lastBlock","_lastBlock","subscribe","addSubscription","processSubscriptionData","data","_processSubscriptionResult","_b","result","jsonRpc","isResponseWithNotification","params","sendSubscriptionRequest","send","method","_buildSubscriptionParams","emit","resubscribe","unsubscribe","removeSubscription","sendUnsubscribeRequest","undefined","formatSubscriptionResult","_processSubscriptionError","error","Error","exports"],"sources":["../../src/web3_subscriptions.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}