{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SendTxHelper = void 0;\n/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\nconst web3_types_1 = require(\"web3-types\");\nconst web3_validator_1 = require(\"web3-validator\");\nconst web3_errors_1 = require(\"web3-errors\");\nconst web3_rpc_methods_1 = require(\"web3-rpc-methods\");\n// eslint-disable-next-line import/no-cycle\nconst get_transaction_gas_pricing_js_1 = require(\"./get_transaction_gas_pricing.js\");\n// eslint-disable-next-line import/no-cycle\nconst try_send_transaction_js_1 = require(\"./try_send_transaction.js\");\n// eslint-disable-next-line import/no-cycle\nconst watch_transaction_for_confirmations_js_1 = require(\"./watch_transaction_for_confirmations.js\");\nconst constants_js_1 = require(\"../constants.js\");\n// eslint-disable-next-line import/no-cycle\nconst get_transaction_error_js_1 = require(\"./get_transaction_error.js\");\n// eslint-disable-next-line import/no-cycle\nconst get_revert_reason_js_1 = require(\"./get_revert_reason.js\");\nconst decoding_js_1 = require(\"./decoding.js\");\nclass SendTxHelper {\n  constructor({\n    options,\n    web3Context,\n    promiEvent,\n    returnFormat\n  }) {\n    this.options = {\n      checkRevertBeforeSending: true\n    };\n    this.options = options;\n    this.web3Context = web3Context;\n    this.promiEvent = promiEvent;\n    this.returnFormat = returnFormat;\n  }\n  getReceiptWithEvents(data) {\n    var _a, _b;\n    const result = Object.assign({}, data !== null && data !== void 0 ? data : {});\n    if (((_a = this.options) === null || _a === void 0 ? void 0 : _a.contractAbi) && result.logs && result.logs.length > 0) {\n      result.events = {};\n      for (const log of result.logs) {\n        const event = (0, decoding_js_1.decodeEventABI)(constants_js_1.ALL_EVENTS_ABI, log, (_b = this.options) === null || _b === void 0 ? void 0 : _b.contractAbi, this.returnFormat);\n        if (event.event) {\n          result.events[event.event] = event;\n        }\n      }\n    }\n    return result;\n  }\n  checkRevertBeforeSending(tx) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.options.checkRevertBeforeSending !== false) {\n        const reason = yield (0, get_revert_reason_js_1.getRevertReason)(this.web3Context, tx, this.options.contractAbi);\n        if (reason !== undefined) {\n          throw yield (0, get_transaction_error_js_1.getTransactionError)(this.web3Context, tx, undefined, undefined, this.options.contractAbi, reason);\n        }\n      }\n    });\n  }\n  emitSending(tx) {\n    if (this.promiEvent.listenerCount('sending') > 0) {\n      this.promiEvent.emit('sending', tx);\n    }\n  }\n  populateGasPrice({\n    transactionFormatted,\n    transaction\n  }) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function* () {\n      let result = transactionFormatted;\n      if (!((_a = this.options) === null || _a === void 0 ? void 0 : _a.ignoreGasPricing) && (0, web3_validator_1.isNullish)(transactionFormatted.gasPrice) && ((0, web3_validator_1.isNullish)(transaction.maxPriorityFeePerGas) || (0, web3_validator_1.isNullish)(transaction.maxFeePerGas))) {\n        result = Object.assign(Object.assign({}, transactionFormatted), yield (0, get_transaction_gas_pricing_js_1.getTransactionGasPricing)(transactionFormatted, this.web3Context, web3_types_1.ETH_DATA_FORMAT));\n      }\n      return result;\n    });\n  }\n  signAndSend({\n    wallet,\n    tx\n  }) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (wallet) {\n        const signedTransaction = yield wallet.signTransaction(tx);\n        return (0, try_send_transaction_js_1.trySendTransaction)(this.web3Context, () => __awaiter(this, void 0, void 0, function* () {\n          return web3_rpc_methods_1.ethRpcMethods.sendRawTransaction(this.web3Context.requestManager, signedTransaction.rawTransaction);\n        }), signedTransaction.transactionHash);\n      }\n      return (0, try_send_transaction_js_1.trySendTransaction)(this.web3Context, () => __awaiter(this, void 0, void 0, function* () {\n        return web3_rpc_methods_1.ethRpcMethods.sendTransaction(this.web3Context.requestManager, tx);\n      }));\n    });\n  }\n  emitSent(tx) {\n    if (this.promiEvent.listenerCount('sent') > 0) {\n      this.promiEvent.emit('sent', tx);\n    }\n  }\n  emitTransactionHash(hash) {\n    if (this.promiEvent.listenerCount('transactionHash') > 0) {\n      this.promiEvent.emit('transactionHash', hash);\n    }\n  }\n  emitReceipt(receipt) {\n    if (this.promiEvent.listenerCount('receipt') > 0) {\n      this.promiEvent.emit('receipt',\n      // @ts-expect-error unknown type fix\n      receipt);\n    }\n  }\n  handleError({\n    error,\n    tx\n  }) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function* () {\n      let _error = error;\n      if (_error instanceof web3_errors_1.ContractExecutionError && this.web3Context.handleRevert) {\n        _error = yield (0, get_transaction_error_js_1.getTransactionError)(this.web3Context, tx, undefined, undefined, (_a = this.options) === null || _a === void 0 ? void 0 : _a.contractAbi);\n      }\n      if ((_error instanceof web3_errors_1.InvalidResponseError || _error instanceof web3_errors_1.ContractExecutionError || _error instanceof web3_errors_1.TransactionRevertWithCustomError || _error instanceof web3_errors_1.TransactionRevertedWithoutReasonError || _error instanceof web3_errors_1.TransactionRevertInstructionError) && this.promiEvent.listenerCount('error') > 0) {\n        this.promiEvent.emit('error', _error);\n      }\n      return _error;\n    });\n  }\n  emitConfirmation({\n    receipt,\n    transactionHash\n  }) {\n    if (this.promiEvent.listenerCount('confirmation') > 0) {\n      (0, watch_transaction_for_confirmations_js_1.watchTransactionForConfirmations)(this.web3Context, this.promiEvent, receipt, transactionHash, this.returnFormat);\n    }\n  }\n  handleResolve({\n    receipt,\n    tx\n  }) {\n    var _a, _b, _c;\n    return __awaiter(this, void 0, void 0, function* () {\n      if ((_a = this.options) === null || _a === void 0 ? void 0 : _a.transactionResolver) {\n        return (_b = this.options) === null || _b === void 0 ? void 0 : _b.transactionResolver(receipt);\n      }\n      if (receipt.status === BigInt(0)) {\n        const error = yield (0, get_transaction_error_js_1.getTransactionError)(this.web3Context, tx,\n        // @ts-expect-error unknown type fix\n        receipt, undefined, (_c = this.options) === null || _c === void 0 ? void 0 : _c.contractAbi);\n        if (this.promiEvent.listenerCount('error') > 0) {\n          this.promiEvent.emit('error', error);\n        }\n        throw error;\n      } else {\n        return receipt;\n      }\n    });\n  }\n}\nexports.SendTxHelper = SendTxHelper;","map":{"version":3,"names":["web3_types_1","require","web3_validator_1","web3_errors_1","web3_rpc_methods_1","get_transaction_gas_pricing_js_1","try_send_transaction_js_1","watch_transaction_for_confirmations_js_1","constants_js_1","get_transaction_error_js_1","get_revert_reason_js_1","decoding_js_1","SendTxHelper","constructor","options","web3Context","promiEvent","returnFormat","checkRevertBeforeSending","getReceiptWithEvents","data","result","Object","assign","_a","contractAbi","logs","length","events","log","event","decodeEventABI","ALL_EVENTS_ABI","_b","tx","reason","getRevertReason","undefined","getTransactionError","emitSending","listenerCount","emit","populateGasPrice","transactionFormatted","transaction","ignoreGasPricing","isNullish","gasPrice","maxPriorityFeePerGas","maxFeePerGas","getTransactionGasPricing","ETH_DATA_FORMAT","signAndSend","wallet","signedTransaction","signTransaction","trySendTransaction","__awaiter","ethRpcMethods","sendRawTransaction","requestManager","rawTransaction","transactionHash","sendTransaction","emitSent","emitTransactionHash","hash","emitReceipt","receipt","handleError","error","_error","ContractExecutionError","handleRevert","InvalidResponseError","TransactionRevertWithCustomError","TransactionRevertedWithoutReasonError","TransactionRevertInstructionError","emitConfirmation","watchTransactionForConfirmations","handleResolve","transactionResolver","status","BigInt","_c","exports"],"sources":["../../../src/utils/send_tx_helper.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}